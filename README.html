<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="documentation\style.css" type="text/css" />
</head>
<body>
<h1 id="andrews-behaviour-box">Andrew's Behaviour Box</h1>
<h2 id="version-2.0-duration-discrimination">Version 2.0 Duration Discrimination</h2>
<p>This is the collection of files I use to run my behavioural experiments. Due to continued poor performance I have updated the system to now implement a stimulus duration discrimination task. As before the animal is to report if the stimulus is the same or different. The key difference to the previous version is that the stimulus intensity is locked to it's highest value and the animal simply needs to tell me the difference in the durations.</p>
<p>It runs a routine described by the following diagram</p>
<h2 id="operant-mode">Operant Mode</h2>
<div class="figure">
<img src="./documentation/Flow_diagram.svg" alt="Flow of the behavioural paradigm" />
<p class="caption">Flow of the behavioural paradigm</p>
</div>
<p>The operant mode features the following conditions:</p>
<ol style="list-style-type: decimal">
<li>Randomised selection of left or right trials
<ul>
<li><p>If a run of three trials of the same type are detected the program forces the next trial to be of the other type: ie: 'Left - Left - Left - Left' will be replaced by 'Left - Left - Left - Right' before the fourth trial runs. This is in line with <span class="citation">Guo et al. (<a href="#ref-guo_procedures_2014">2014</a>)</span></p>
<p>This logic is over written if the bias correction is in place.</p></li>
<li><p>In addition to the bias correction weighting, another bias correction mechanism prevents the animal from having a straight run of successes on one side. If 5 rewards are delivered on one side, without any delivered on the other side, the system will lock off that side. The associated stimulus will not be presented until the animal gets at least three rewards from the opposite port. This is in line with <span class="citation">Guo et al. (<a href="#ref-guo_procedures_2014">2014</a>)</span></p></li>
</ul></li>
</ol>
<h1 id="serialcontroller.py">SerialController.py</h1>
<pre><code>usage: SerialControl.py [-h] [-b] [-lt LICKTHRES] [--verbose]
                        [--repeats REPEATS] [-a] [--port PORT]
                        [--t_stimDELAY T_STIMDELAY] [--ITI ITI ITI]
                        [-rdur T_RDUR] [--dur DUR DUR] [-m MODE]
                        [--t_stimONSET T_STIMONSET] [--datapath DATAPATH]
                        [-rs] [-i ID] [-bc] [-nlp NOLICK] [-w WEIGHT]
                        [-N TRIAL_NUM] [-td TRIALDUR] [-rdel T_RDELAY] [-p]
                        [-to TIMEOUT] [-s] [-lc LCOUNT] [-L | -R]</code></pre>
<h3 id="requires">Requires</h3>
<ul>
<li><a href="https://www.microsoft.com/en-au/software-download/windows7">Windows 7</a></li>
<li><a href="http://pandas.pydata.org">Pandas</a></li>
<li><a href="http://www.numpy.org/">Numpy</a></li>
<li><a href="https://github.com/pyserial/pyserial">Pyserial</a></li>
<li><a href="https://pypi.python.org/pypi/colorama">Colorama</a></li>
<li>An Arduino running <code>behaviourbox.ino</code> connected to the same computer</li>
</ul>
<h2 id="optional-arguments">Optional Arguments:</h2>
<pre><code>optional arguments:
  -h, --help            show this help message and exit
  -b, --blanks          include no stim trials
  -lt LICKTHRES, --lickThres LICKTHRES
                        set `lickThres` in arduino
  --verbose             for debug this will print everything if enabled
  --repeats REPEATS     the number of times this block should repeat, by
                        default this is 1
  -a, --auditory        switch to auditory stimulus instead of somatosensory
  --port PORT           port that the Arduino is connected to
  --t_stimDELAY T_STIMDELAY
                        sets the time between succesive stimuli
  --ITI ITI ITI         an interval for randomising between trials
  -rdur T_RDUR, --t_rDUR T_RDUR
                        set end time of reward epoch
  --dur DUR DUR         Durations or to be passed to arduino as DUR_short and
                        DUR_long
  -m MODE, --mode MODE  the mode `h`abituaton or `o`perant, by default will
                        look in the config table
  --t_stimONSET T_STIMONSET
                        sets the time after trigger to run the first stimulus
  --datapath DATAPATH   path to save data to, by default is
                        &#39;C:/DATA/Andrew/wavesurfer/%YY%MM%DD&#39;
  -rs, --right_same     define the right port as correct for same stimulus
  -i ID, --ID ID        identifier for this animal/run
  -bc, --bias_correct   turn on the bias correction for the random number
                        generator
  -nlp NOLICK, --noLick NOLICK
                        set `t_noLickPer` in arduino
  -w WEIGHT, --weight WEIGHT
                        weight of the animal in grams
  -N TRIAL_NUM, --trial_num TRIAL_NUM
                        trial number to start at
  -td TRIALDUR, --trialDur TRIALDUR
                        set minimum trial duration
  -rdel T_RDELAY, --t_rDELAY T_RDELAY
                        set start time of reward epoch
  -p, --punish          sets `break_wrongChoice` to True, incorrect licks will
                        end an operant trial early
  -to TIMEOUT, --timeout TIMEOUT
                        set the timeout duration for incorrect licks
  -s, --single          use this flag for a single stimulus only
  -lc LCOUNT, --lcount LCOUNT
                        set `minlickCount` in arduino
  -L, --left
  -R, --right</code></pre>
<p>See Also <a href="http://xkcd.com/1692/">list of rejected arguments</a></p>
<h2 id="interactive-options">Interactive Options</h2>
<table>
<thead>
<tr class="header">
<th align="left">key</th>
<th align="left">option</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">H</td>
<td align="left">This menu</td>
</tr>
<tr class="even">
<td align="left">P</td>
<td align="left">Punish</td>
</tr>
<tr class="odd">
<td align="left">S</td>
<td align="left">toggle single stimulus</td>
</tr>
<tr class="even">
<td align="left">&lt; &gt;</td>
<td align="left">lick threshold</td>
</tr>
<tr class="odd">
<td align="left">?</td>
<td align="left">show threshold</td>
</tr>
<tr class="even">
<td align="left">[ ]</td>
<td align="left">lickcount</td>
</tr>
<tr class="odd">
<td align="left">\</td>
<td align="left">show lickcount</td>
</tr>
<tr class="even">
<td align="left">tab</td>
<td align="left">toggle mode</td>
</tr>
<tr class="odd">
<td align="left">: &quot;</td>
<td align="left">adjust noLick period</td>
</tr>
<tr class="even">
<td align="left">L</td>
<td align="left">show noLick period</td>
</tr>
<tr class="odd">
<td align="left">( )</td>
<td align="left">adjust trial duration</td>
</tr>
<tr class="even">
<td align="left">T</td>
<td align="left">show trial duration period</td>
</tr>
<tr class="odd">
<td align="left">Y</td>
<td align="left">toggle timeout (requires punish to take effect)</td>
</tr>
<tr class="even">
<td align="left">B</td>
<td align="left">toggle bias correction</td>
</tr>
<tr class="odd">
<td align="left">input <code>rdel</code></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">input <code>rdur</code></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<ol style="list-style-type: decimal">
<li>The program starts</li>
<li><p>The program opens communications with available serial port The program waits until it gets the arduino is active, and prints all output until the ready signal is transmitted. Which is <code>-- Status: Ready --</code></p></li>
<li>The program starts a block</li>
<li><p>The program transmits the dict <code>params</code>, which holds all parameters for a single trial. The condition values get updated; based on the frequencies being sent, all contents of <code>params</code> are transmitted to the behaviour controller.</p></li>
<li>The program prints the frequencies and the condition to the screen and a random timeout is started.</li>
<li>The program initiates a trial by sending a literal <code>&quot;GO&quot;</code> to the behaviour box.
<ul>
<li>The behaviour box runs one trial, with the parameters set previously</li>
</ul></li>
<li><p>The program records the output from behaviorCOMs into a dict, which later will be converted to a data frame for analysis.</p></li>
<li><p>The program repeats sending mode flags until all stimuli combinations have been run through.</p></li>
</ol>
<h1 id="behaviourbox.ino">behaviourbox.ino</h1>
<p>This program delivers sensory stimulation and opens water valve when the animal touches the licking sensor within a certain time window.</p>
<h3 id="requirements">Requirements</h3>
<ul>
<li><dl>
<dt><a href="https://www.arduino.cc/en/Main/ArduinoBoardUno">Arduino uno Rev3</a></dt>
<dd>Connects to the main computer via USB serial
</dd>
</dl></li>
<li><dl>
<dt>stimulus</dt>
<dd>The stimulus needs to take 3.3V digital signal, and be driven by a square wave.
</dd>
</dl></li>
<li><dl>
<dt>2×lick ports</dt>
<dd><p>I use peizo electric wafers, specifically a <a href="http://www.piezodriveonline.com/0-6mm-range-piezo-bender-actuator-ba3502/">0.6mm Range Piezo Bender Actuator</a> from PiezoDrive Pty Ltd, (Callaghn NSW)</p>
<ul>
<li>The signal from these are very small. The piezos require a linear amplifier so that the arduino can detect the signal they produce. I use 2× custom made linear amplifiers that each take 5V DC input and output in a range from 0-3V. The amplifiers come are from Larkum lab designs.</li>
</ul>
</dd>
</dl></li>
</ul>
<h2 id="setup-connections">Setup connections:</h2>
<table>
<caption>Digital connections to lick controller</caption>
<thead>
<tr class="header">
<th align="left">DIGITAL</th>
<th align="left">output</th>
<th align="left">variable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">pin 2</td>
<td align="left">recording trigger</td>
<td align="left"><code>recTrig</code></td>
</tr>
<tr class="even">
<td align="left">pin 3</td>
<td align="left">stimulus</td>
<td align="left"><code>stimulusPin</code></td>
</tr>
<tr class="odd">
<td align="left">pin 8</td>
<td align="left">speaker</td>
<td align="left"><code>speakerPin</code></td>
</tr>
<tr class="even">
<td align="left">pin 10</td>
<td align="left">left water valve</td>
<td align="left"><code>waterValve[0]</code></td>
</tr>
<tr class="odd">
<td align="left">pin 11</td>
<td align="left">right water valve</td>
<td align="left"><code>waterValve[1]</code></td>
</tr>
</tbody>
</table>
<table>
<caption>Analog connections to lick controller</caption>
<thead>
<tr class="header">
<th align="left">ANALOG</th>
<th align="left">input</th>
<th align="left"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">A0</td>
<td align="left">left lick sensor</td>
<td align="left"><code>lickSens[0]</code></td>
</tr>
<tr class="even">
<td align="left">A1</td>
<td align="left">right lick sensor</td>
<td align="left"><code>lickSens[1]</code></td>
</tr>
</tbody>
</table>
<h2 id="global-variables">Global Variables</h2>
<table>
<caption>connections</caption>
<thead>
<tr class="header">
<th align="left">type</th>
<th align="left">name</th>
<th align="left">value</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">const</span> <span class="dt">char</span></code></td>
<td align="left">recTrig</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">2</span></code></td>
<td align="left">digital pin 2 triggers ITC-18</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">const</span> <span class="dt">char</span></code></td>
<td align="left">stimulusPin</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">3</span></code></td>
<td align="left">digital pin 4 control whisker stimulation</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">const</span> <span class="dt">char</span></code></td>
<td align="left">speakerPin</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">8</span></code></td>
<td align="left">digital pin 8 control water valve</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">const</span> <span class="dt">char</span></code></td>
<td align="left">statusLED</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">13</span></code></td>
<td align="left">led connected to digital pin 13</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">const</span> <span class="dt">char</span>[<span class="dv">2</span>]</code></td>
<td align="left">waterPort</td>
<td align="left"><code class="sourceCode cpp">{<span class="dv">10</span>,<span class="dv">11</span>}</code></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">const</span> <span class="dt">char</span></code></td>
<td align="left">lickRep</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">13</span></code></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">const</span> <span class="dt">char</span>[<span class="dv">2</span>]</code></td>
<td align="left">lickSens</td>
<td align="left"><code class="sourceCode cpp">{A0,A1}</code></td>
<td align="left">the piezos are connected to analog pins 0 and 1</td>
</tr>
</tbody>
</table>
<table>
<caption>timing parameters</caption>
<thead>
<tr class="header">
<th align="left">type</th>
<th align="left">name</th>
<th align="left">value</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">unsigned</span> <span class="dt">long</span></code></td>
<td align="left">t_init</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">unsigned</span> <span class="dt">int</span></code></td>
<td align="left">t_noLickPer</td>
<td align="left">1000</td>
<td align="left">ms</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">unsigned</span> <span class="dt">int</span></code></td>
<td align="left">trial_delay</td>
<td align="left">500</td>
<td align="left">ms</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">unsigned</span> <span class="dt">int</span></code></td>
<td align="left">t_stimONSET</td>
<td align="left">2000</td>
<td align="left">ms</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">unsigned</span> <span class="dt">int</span></code></td>
<td align="left">t_stimDELAY</td>
<td align="left">150</td>
<td align="left">ms</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">unsigned</span> <span class="dt">int</span></code></td>
<td align="left">stimDUR</td>
<td align="left">500</td>
<td align="left">ms</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">unsigned</span> <span class="dt">int</span></code></td>
<td align="left">t_rDELAY</td>
<td align="left">2100</td>
<td align="left">ms</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">unsigned</span> <span class="dt">int</span></code></td>
<td align="left">t_rDUR</td>
<td align="left">2000</td>
<td align="left">ms</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">unsigned</span> <span class="dt">int</span></code></td>
<td align="left">timeout</td>
<td align="left">0</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<table>
<caption>Misc</caption>
<thead>
<tr class="header">
<th align="left">type</th>
<th align="left">name</th>
<th align="left">value</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">char</span></code></td>
<td align="left">mode</td>
<td align="left"><code class="sourceCode cpp"><span class="st">&#39;-&#39;</span></code></td>
<td align="left">one of <code>h</code>abituation, <code>o</code>perant</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">char</span></code></td>
<td align="left">rewardCond</td>
<td align="left"><code class="sourceCode cpp"><span class="st">&#39;R&#39;</span></code></td>
<td align="left">a value that is 'L' 'R', 'B' or 'N' to represent lick port to be used</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp">byte</code></td>
<td align="left">minlickCount</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">5</span></code></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp">byte[<span class="dv">2</span>]</code></td>
<td align="left">reward_count</td>
<td align="left"><code class="sourceCode cpp">{<span class="dv">0</span>, <span class="dv">0</span>}</code></td>
<td align="left">Globals to count number of continuous left and rights</td>
</tr>
</tbody>
</table>
<table>
<caption>stimulus parameters</caption>
<colgroup>
<col width="26%" />
<col width="17%" />
<col width="42%" />
<col width="13%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">type</th>
<th align="left">name</th>
<th align="left">value</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">bool</span></code></td>
<td align="left">single_stim</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">bool</span></code></td>
<td align="left">right_same</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span></code></td>
<td align="left">DUR_short</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">100</span></code></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span></code></td>
<td align="left">DUR_long</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">500</span></code></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span>[<span class="dv">2</span>][<span class="dv">2</span>]</code></td>
<td align="left">diff_DUR</td>
<td align="left"><code class="sourceCode cpp">{{DUR_short, DUR_long},</code> <code class="sourceCode cpp">{  DUR_long, DUR_short}}</code></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span>[<span class="dv">2</span>][<span class="dv">2</span>]</code></td>
<td align="left">same_DUR</td>
<td align="left"><code class="sourceCode cpp">{{ DUR_long, DUR_long},</code> <code class="sourceCode cpp">{DUR_short, DUR_short}}</code></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">bool</span></code></td>
<td align="left">right</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">1</span></code></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">bool</span></code></td>
<td align="left">left</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">0</span></code></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span>[<span class="dv">2</span>][<span class="dv">2</span>]</code></td>
<td align="left">right_DUR</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span>[<span class="dv">2</span>][<span class="dv">2</span>]</code></td>
<td align="left">left_DUR</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<table>
<caption>audio</caption>
<thead>
<tr class="header">
<th align="left">type</th>
<th align="left">name</th>
<th align="left">value</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">bool</span></code></td>
<td align="left">auditory</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">0</span></code></td>
<td align="left">Logical value. Runs in auditory mode when true</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span></code></td>
<td align="left">toneGoodLeft</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">6000</span></code></td>
<td align="left">Hz</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span></code></td>
<td align="left">toneGoodRight</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">7000</span></code></td>
<td align="left">Hz</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span></code></td>
<td align="left">toneGood</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">2000</span></code></td>
<td align="left">Hz</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span></code></td>
<td align="left">toneBad</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">500</span></code></td>
<td align="left">Hz</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span></code></td>
<td align="left">toneDur</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">100</span></code></td>
<td align="left">ms</td>
</tr>
</tbody>
</table>
<table>
<caption>Reward</caption>
<thead>
<tr class="header">
<th align="left">type</th>
<th align="left">name</th>
<th align="left">value</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code class="sourceCode cpp">byte[<span class="dv">2</span>]</code></td>
<td align="left">count</td>
<td align="left"><code class="sourceCode cpp">{<span class="dv">0</span>,<span class="dv">0</span>}</code></td>
<td align="left">Global value to count the licks</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">char</span></code></td>
<td align="left">waterVol</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">10</span></code></td>
<td align="left">uL per dispense</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">int</span></code></td>
<td align="left">lickThres</td>
<td align="left"><code class="sourceCode cpp"><span class="dv">450</span></code></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">bool</span>[<span class="dv">2</span>]</code></td>
<td align="left">lickOn</td>
<td align="left"><code class="sourceCode cpp">{<span class="kw">false</span>, <span class="kw">false</span>}</code></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dt">bool</span></code></td>
<td align="left">verbose</td>
<td align="left"><code class="sourceCode cpp"><span class="kw">true</span></code></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="dt">bool</span></code></td>
<td align="left">break_wrongChoice</td>
<td align="left"><code class="sourceCode cpp"><span class="kw">false</span></code></td>
<td align="left">stop if the animal makes a mistake</td>
</tr>
</tbody>
</table>
<h2 id="start-program">Start program</h2>
<p>The arduino program is a little complicated; but in principle a simple setup. The main method is <code>runTrial</code> which on initialisation:</p>
<ol style="list-style-type: decimal">
<li>Waits a period of ms defined by <code>trial_delay</code>. In this period the timer counts up to zero; and the sensors detect licks. 10 ms before zero, a pulse is sent to the <code>recTrig</code> to trigger the recording</li>
<li>Next two periods of <code>ActiveDelay</code> are intialised in sequence. Two are used so that if I decide the set a <code>noLickPer</code> time, I can have that come on a short time after the trigger. <code>ActiveDelay</code> has the condition <code>break_on_lick</code> as it's second argument. If <code>true</code> the program will exit the function before it reaches the time that it is set to delay until.</li>
<li>Two stimuli are delivered, separated by an <code>ActiveDelay</code> method.</li>
<li>After another <code>ActiveDelay</code> the program enters the <code>TrialReward</code> period, if <code>rewardCond</code> is not <code>'N'</code>, which stands for neither port giving water. During the <code>TrialReward</code> phase, if the <code>mode</code> is <code>c</code> then water is dispensed immediately from the associated port.</li>
<li>The program delays again, and then exits the <code>runTrial</code> function. Resulting in the program sending the ready string to the Serial controller.</li>
</ol>
<p>Now also includes a mode switch. Using <code>&lt;tab&gt;</code> you can switch between operant and habituation modes. In habituation the animal is delivered a pair of randomly selected stimuli, which match the reward condition when it licks the water ports. Following the stimulus delivery a reward is dispensed on the port that the animal licked. In this mode an upper limit on the number of contiguous successful trials on the same side is used (Thanks to Conrad Lee from ANU). A counter keeps track of the number of licks, and if the counter reaches 10 the associated port becomes inactive. Licking the other port subtracts 1 from the counter. In this way the animal must balance it's attention on both ports.</p>
<h2 id="functions">Functions</h2>
<p>In addition to the basic functionality the program also features modules that do the following:</p>
<dl>
<dt><code>t_now(t_init)</code></dt>
<dd>Returns the number of milliseconds since <code>t_init</code>. <code>t_init</code> is a global unsigned long. It takes the value of <code>millis()</code> at the start of a run; which in turn is the number of milliseconds since the Arduino was turned on.
</dd>
<dt><code>senseLickChange(bool sensor)</code></dt>
<dd><p><code>sensor</code> is a Boolean, because I only have implemented two lick sensors, which can be 0 or 1, for the left and right sensors respectively. This function reads the value of the analog input defined by <code>lickSens[sensor]</code>. If this is greater than the threshold the function returns true, and sets the <code>lickRep[sensor]</code> pin to ON.</p>
<p>In addition this function includes a line to set the speaker to be ON or OFF at random. This is how the auditory masking noise is produced. A consequence of this is that each state the controller gets in has a different timbre. The obvious solution is to use a PC speaker to go to <code>youtube&gt;10 hours of white noise</code> instead of this tangled solution!</p>
</dd>
<dt><code>getSerialInput()</code></dt>
<dd>Returns data from the serial port as a string. <code>while Serial.available()</code>
</dd>
<dt><code>getSepIndex(string, sep)</code></dt>
<dd><p>Returns the first index at which the character <code>sep</code> is found in <code>string</code>. If no separator is present this function will return 0.</p>
<p>(Possible source of bugs, it would be better to uses -1 and to check that the output is valid on call!)</p>
</dd>
<dt><code>flutter(off)</code></dt>
<dd>This function runs single square pulse on <code>stim_pin</code> which is high for the duration <code>on</code>, defined in microseconds. The <code>off</code> value gives a delay in which the pin is in low state such that by stringing multiple of these together I can generate a square wave.
</dd>
<dt><code>ActiveDelay(wait, break_on_lick = false, verbose = true)</code></dt>
<dd><p>Returns true if a lick is detected in the period defined by <code>wait</code>. <code>wait</code> is some time relative to the time that the trial started (<code>t_init</code>).</p>
<p>if <code>break_on_lick</code> is set true, this function will return before the end of the delay period.</p>
<p>TODO: It would be best to make the return value depend on whether or not an early break has happened!</p>
</dd>
<dt><code>preTrial(verbose = true)</code></dt>
<dd>While the trial has not started 1. update the time 2. check for licks 4. trigger the recording by putting recTrig -&gt; HIGH 5. flash the LED each second.
</dd>
<dt><code>UpdateGlobals(input)</code></dt>
<dd>This function parses an <code>input</code> string and uses it to set the value of global paramaters. If the input is of the form <code>variablename : value</code> <code>variablename</code> will be updated to be equal to <code>value</code>
</dd>
<dt><code>TrialReward()</code></dt>
<dd><p>This function returns a character corresponding to the lick status</p>
<table>
<tbody>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="st">&#39;L&#39;</span></code></td>
<td align="left">correct hit on left port</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="st">&#39;R&#39;</span></code></td>
<td align="left">correct hit on right port</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="st">&#39;l&#39;</span></code></td>
<td align="left">incorrect lick on left port</td>
</tr>
<tr class="even">
<td align="left"><code class="sourceCode cpp"><span class="st">&#39;r&#39;</span></code></td>
<td align="left">incorrect lick on right port</td>
</tr>
<tr class="odd">
<td align="left"><code class="sourceCode cpp"><span class="dv">0</span></code></td>
<td align="left">No lick detected during reward period</td>
</tr>
</tbody>
</table>
</dd>
</dl>
<h2 id="serial-input-output">Serial Input / Output</h2>
<p><em>or Poor mans introspection</em></p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">
lickThres = variable_value.toInt();

mode = variable_value[<span class="dv">0</span>];

rewardCond = variable_value[<span class="dv">0</span>];

break_wrongChoice = <span class="dt">bool</span>(variable_value.toInt());

minlickCount = variable_value.toInt();

t_noLickPer = variable_value.toInt();

right_same = <span class="dt">bool</span>(variable_value.toInt());

auditory = <span class="dt">bool</span>(variable_value.toInt());

single_stim = <span class="dt">bool</span>(variable_value.toInt());

timeout = variable_value.toInt();

t_stimDUR = variable_value.toInt();

t_stimONSET = variable_value.toInt();

t_rDELAY = variable_value.toInt();

t_rDUR = variable_value.toInt();

waterVol = variable_value.toInt();

DUR_short = variable_value.toInt();

DUR_long = variable_value.toInt();

OFF = variable_value.toInt();</code></pre></div>
<h1 id="plot_stats.py">plot_stats.py</h1>
<h3 id="requires-1">Requires</h3>
<ul>
<li><a href="http://bokeh.pydata.org">Bokeh</a></li>
<li><a href="http://pandas.pydata.org">Pandas</a></li>
<li><a href="http://www.numpy.org/">Numpy</a></li>
</ul>
<h1 id="references" class="unnumbered">References</h1>
<div id="refs" class="references">
<div id="ref-guo_procedures_2014">
<p>Guo, Zengcai V., S. Andrew Hires, Nuo Li, Daniel H. O’Connor, Takaki Komiyama, Eran Ophir, Daniel Huber, et al. 2014. “Procedures for Behavioral Experiments in Head-Fixed Mice.” <em>PLoS ONE</em> 9 (2): e88678. doi:<a href="http://doi.org/10.1371/journal.pone.0088678">10.1371/journal.pone.0088678</a>.</p>
</div>
</div>
</body>
</html>
